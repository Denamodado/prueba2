<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Previsualizador de Imágenes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <!-- Importa las librerías de Firebase solo si la aplicación está en línea -->
    <script>
        if (location.protocol !== 'file:') {
            document.write('<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"><\/script>');
            document.write('<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"><\/script>');
            document.write('<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"><\/script>');
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Instrucciones -->
    <div class="p-4 bg-blue-500 text-white text-center">
        <h1 class="text-2xl font-bold">Previsualizador de Imágenes</h1>
        <p>Abre y utiliza la aplicación haciendo doble clic en este archivo HTML.</p>
    </div>

    <!-- Contenedor principal -->
    <div class="flex-grow container mx-auto p-4">

        <!-- Área de arrastre y carga -->
        <div id="drop-area" class="border-4 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center cursor-pointer bg-white">
            <p id="placeholder-text" class="text-gray-500 text-center">
                Arrastra y suelta tus imágenes aquí o haz doble clic para cargar.
            </p>
            <input type="file" id="fileElem" multiple accept="image/*" class="hidden">
        </div>

        <!-- Galería de imágenes -->
        <div id="gallery" class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Las imágenes se insertarán aquí -->
        </div>

    </div>

    <!-- JavaScript -->
    <script>
        // Variables globales
        let db; // Para IndexedDB
        let isOnline = location.protocol !== 'file:';

        if (isOnline) {
            // Configuración de Firebase
            const firebaseConfig = {
                apiKey: "TU_API_KEY",
                authDomain: "TU_AUTH_DOMAIN",
                projectId: "TU_PROJECT_ID",
                storageBucket: "TU_STORAGE_BUCKET",
                messagingSenderId: "TU_MESSAGING_SENDER_ID",
                appId: "TU_APP_ID",
                databaseURL: "TU_DATABASE_URL"
            };

            // Inicializar Firebase
            firebase.initializeApp(firebaseConfig);
            var storage = firebase.storage();
            var database = firebase.database();
        }

        // Asignar eventos al cargar el DOM
        document.addEventListener('DOMContentLoaded', () => {
            if (isOnline) {
                loadImagesOnline();
            } else {
                initDB();
            }

            // Elementos del DOM
            const dropArea = document.getElementById('drop-area');
            const fileElem = document.getElementById('fileElem');

            // Evento de doble clic para abrir el selector de archivos
            dropArea.addEventListener('dblclick', () => {
                fileElem.click();
            });

            // Eventos de arrastrar y soltar
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('border-blue-500');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('border-blue-500');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('border-blue-500');
                let dt = e.dataTransfer;
                let files = dt.files;
                handleFiles(files);
            });

            // Evento de cambio en el input de archivos
            fileElem.addEventListener('change', () => {
                handleFiles(fileElem.files);
            });
        });

        // Manejar archivos seleccionados
        function handleFiles(files) {
            [...files].forEach(file => {
                if (isOnline) {
                    uploadFileOnline(file);
                } else {
                    previewFileLocal(file);
                }
            });
        }

        /*** Modo Offline (Local) ***/
        // Inicializar IndexedDB
        function initDB() {
            const request = indexedDB.open('imageDB', 1);

            request.onupgradeneeded = function(event) {
                db = event.target.result;
                db.createObjectStore('images', { keyPath: 'id', autoIncrement: true });
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                loadImagesLocal();
            };

            request.onerror = function(event) {
                console.error('Error al abrir IndexedDB:', event.target.errorCode);
            };
        }

        // Previsualizar y almacenar archivos localmente
        function previewFileLocal(file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                saveImageLocal(event.target.result);
            };
            reader.onerror = function(error) {
                console.error('Error al leer el archivo:', error);
                alert('Se produjo un error al cargar la imagen.');
            };
        }

        // Guardar imagen en IndexedDB
        function saveImageLocal(imageDataUrl) {
            const transaction = db.transaction(['images'], 'readwrite');
            const objectStore = transaction.objectStore('images');
            const request = objectStore.add({ data: imageDataUrl });

            request.onsuccess = function(event) {
                loadImagesLocal();
            };

            request.onerror = function(event) {
                console.error('Error al guardar la imagen:', event.target.errorCode);
            };
        }

        // Cargar imágenes desde IndexedDB
        function loadImagesLocal() {
            const transaction = db.transaction(['images'], 'readonly');
            const objectStore = transaction.objectStore('images');
            const request = objectStore.getAll();

            request.onsuccess = function(event) {
                const images = event.target.result;
                updateGalleryLocal(images);
            };
        }

        // Actualizar galería local
        function updateGalleryLocal(images) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            if (images.length === 0) {
                document.getElementById('placeholder-text').style.display = 'block';
            } else {
                document.getElementById('placeholder-text').style.display = 'none';
            }

            images.forEach((imageObj) => {
                const imageSrc = imageObj.data;
                const id = imageObj.id;

                const div = document.createElement('div');
                div.classList.add('relative', 'group');

                const img = document.createElement('img');
                img.src = imageSrc;
                img.classList.add('w-full', 'h-auto', 'rounded-lg');

                // Botón de eliminar
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '✕';
                deleteBtn.setAttribute('aria-label', 'Eliminar imagen');
                deleteBtn.classList.add('absolute', 'top-2', 'right-2', 'bg-red-500', 'text-white', 'rounded-full', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'opacity-0', 'group-hover:opacity-100', 'transition');
                deleteBtn.onclick = () => {
                    deleteImageLocal(id);
                };

                // Botón de sustituir
                const replaceBtn = document.createElement('button');
                replaceBtn.innerHTML = '⟳';
                replaceBtn.setAttribute('aria-label', 'Sustituir imagen');
                replaceBtn.classList.add('absolute', 'top-2', 'left-2', 'bg-yellow-500', 'text-white', 'rounded-full', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'opacity-0', 'group-hover:opacity-100', 'transition');
                replaceBtn.onclick = () => {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';
                    fileInput.onchange = () => {
                        const file = fileInput.files[0];
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = function(event) {
                            replaceImageLocal(id, event.target.result);
                        };
                        reader.onerror = function(error) {
                            console.error('Error al leer el archivo:', error);
                            alert('Se produjo un error al cargar la imagen.');
                        };
                    };
                    fileInput.click();
                };

                div.appendChild(img);
                div.appendChild(deleteBtn);
                div.appendChild(replaceBtn);
                gallery.appendChild(div);
            });
        }

        // Eliminar imagen de IndexedDB
        function deleteImageLocal(id) {
            const transaction = db.transaction(['images'], 'readwrite');
            const objectStore = transaction.objectStore('images');
            const request = objectStore.delete(id);

            request.onsuccess = function(event) {
                loadImagesLocal();
            };

            request.onerror = function(event) {
                console.error('Error al eliminar la imagen:', event.target.errorCode);
            };
        }

        // Reemplazar imagen en IndexedDB
        function replaceImageLocal(id, imageDataUrl) {
            const transaction = db.transaction(['images'], 'readwrite');
            const objectStore = transaction.objectStore('images');
            const request = objectStore.put({ id: id, data: imageDataUrl });

            request.onsuccess = function(event) {
                loadImagesLocal();
            };

            request.onerror = function(event) {
                console.error('Error al reemplazar la imagen:', event.target.errorCode);
            };
        }

        /*** Modo Online ***/
        // Subir archivo a Firebase Storage
        function uploadFileOnline(file) {
            const storageRef = storage.ref('images/' + file.name);
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    // Progreso de la carga (opcional)
                },
                (error) => {
                    console.error('Error al cargar el archivo:', error);
                    alert('Se produjo un error al cargar la imagen.');
                },
                () => {
                    // Carga exitosa
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        saveImageDataOnline(file.name, downloadURL);
                    });
                }
            );
        }

        // Guardar datos de la imagen en Firebase Database
        function saveImageDataOnline(fileName, downloadURL) {
            const imageData = {
                name: fileName,
                url: downloadURL
            };
            const newImageKey = database.ref().child('images').push().key;
            const updates = {};
            updates['/images/' + newImageKey] = imageData;
            database.ref().update(updates).then(() => {
                loadImagesOnline();
            });
        }

        // Cargar imágenes desde Firebase Database
        function loadImagesOnline() {
            database.ref('images/').once('value').then((snapshot) => {
                const images = [];
                snapshot.forEach((childSnapshot) => {
                    const imageData = childSnapshot.val();
                    imageData.key = childSnapshot.key;
                    images.push(imageData);
                });
                updateGalleryOnline(images);
            });
        }

        // Actualizar galería en línea
        function updateGalleryOnline(images) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            if (images.length === 0) {
                document.getElementById('placeholder-text').style.display = 'block';
            } else {
                document.getElementById('placeholder-text').style.display = 'none';
            }

            images.forEach((imageData) => {
                const imageSrc = imageData.url;
                const key = imageData.key;

                const div = document.createElement('div');
                div.classList.add('relative', 'group');

                const img = document.createElement('img');
                img.src = imageSrc;
                img.classList.add('w-full', 'h-auto', 'rounded-lg');

                // Botón de eliminar
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '✕';
                deleteBtn.setAttribute('aria-label', 'Eliminar imagen');
                deleteBtn.classList.add('absolute', 'top-2', 'right-2', 'bg-red-500', 'text-white', 'rounded-full', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'opacity-0', 'group-hover:opacity-100', 'transition');
                deleteBtn.onclick = () => {
                    deleteImageOnline(key, imageData.name);
                };

                // Botón de sustituir
                const replaceBtn = document.createElement('button');
                replaceBtn.innerHTML = '⟳';
                replaceBtn.setAttribute('aria-label', 'Sustituir imagen');
                replaceBtn.classList.add('absolute', 'top-2', 'left-2', 'bg-yellow-500', 'text-white', 'rounded-full', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'opacity-0', 'group-hover:opacity-100', 'transition');
                replaceBtn.onclick = () => {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';
                    fileInput.onchange = () => {
                        const file = fileInput.files[0];
                        replaceImageOnline(key, imageData.name, file);
                    };
                    fileInput.click();
                };

                div.appendChild(img);
                div.appendChild(deleteBtn);
                div.appendChild(replaceBtn);
                gallery.appendChild(div);
            });
        }

        // Eliminar imagen de Firebase
        function deleteImageOnline(key, fileName) {
            // Eliminar de Firebase Storage
            const storageRef = storage.ref('images/' + fileName);
            storageRef.delete().then(() => {
                // Eliminar de Firebase Database
                database.ref('images/' + key).remove().then(() => {
                    loadImagesOnline();
                });
            }).catch((error) => {
                console.error('Error al eliminar la imagen:', error);
                alert('No se pudo eliminar la imagen.');
            });
        }

        // Reemplazar imagen en Firebase
        function replaceImageOnline(key, oldFileName, newFile) {
            deleteImageOnline(key, oldFileName);
            uploadFileOnline(newFile);
        }
    </script>
</body>
</html>

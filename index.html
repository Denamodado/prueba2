<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Previsualizador de Imágenes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <!-- Importa las librerías de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Instrucciones -->
    <div class="p-4 bg-blue-500 text-white text-center">
        <h1 class="text-2xl font-bold">Previsualizador de Imágenes</h1>
        <p>Abre y utiliza la aplicación haciendo doble clic en este archivo HTML.</p>
    </div>

    <!-- Contenedor principal -->
    <div class="flex-grow container mx-auto p-4">

        <!-- Área de arrastre y carga -->
        <div id="drop-area" class="border-4 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center cursor-pointer bg-white">
            <p id="placeholder-text" class="text-gray-500 text-center">
                Arrastra y suelta tus imágenes aquí o haz doble clic para cargar.
            </p>
            <input type="file" id="fileElem" multiple accept="image/*" class="hidden">
        </div>

        <!-- Galería de imágenes -->
        <div id="gallery" class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Las imágenes se insertarán aquí -->
        </div>

    </div>

    <!-- JavaScript -->
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID",
            databaseURL: "TU_DATABASE_URL"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const database = firebase.database();

        // Asignar eventos al cargar el DOM
        document.addEventListener('DOMContentLoaded', () => {
            loadImages();

            // Elementos del DOM
            const dropArea = document.getElementById('drop-area');
            const fileElem = document.getElementById('fileElem');

            // Evento de doble clic para abrir el selector de archivos
            dropArea.addEventListener('dblclick', () => {
                fileElem.click();
            });

            // Eventos de arrastrar y soltar
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('border-blue-500');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('border-blue-500');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('border-blue-500');
                let dt = e.dataTransfer;
                let files = dt.files;
                handleFiles(files);
            });

            // Evento de cambio en el input de archivos
            fileElem.addEventListener('change', () => {
                handleFiles(fileElem.files);
            });
        });

        // Manejar archivos seleccionados
        function handleFiles(files) {
            [...files].forEach(uploadFile);
        }

        // Subir archivo a Firebase Storage
        function uploadFile(file) {
            const storageRef = storage.ref('images/' + file.name);
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    // Progreso de la carga (opcional)
                },
                (error) => {
                    console.error('Error al cargar el archivo:', error);
                    alert('Se produjo un error al cargar la imagen.');
                },
                () => {
                    // Carga exitosa
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        saveImageData(file.name, downloadURL);
                    });
                }
            );
        }

        // Guardar datos de la imagen en Firebase Database
        function saveImageData(fileName, downloadURL) {
            const imageData = {
                name: fileName,
                url: downloadURL
            };
            const newImageKey = database.ref().child('images').push().key;
            const updates = {};
            updates['/images/' + newImageKey] = imageData;
            database.ref().update(updates).then(() => {
                loadImages();
            });
        }

        // Cargar imágenes desde Firebase Database
        function loadImages() {
            database.ref('images/').once('value').then((snapshot) => {
                const images = [];
                snapshot.forEach((childSnapshot) => {
                    const imageData = childSnapshot.val();
                    imageData.key = childSnapshot.key;
                    images.push(imageData);
                });
                updateGallery(images);
            });
        }

        // Actualizar galería
        function updateGallery(images) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            if (images.length === 0) {
                document.getElementById('placeholder-text').style.display = 'block';
            } else {
                document.getElementById('placeholder-text').style.display = 'none';
            }

            images.forEach((imageData) => {
                const imageSrc = imageData.url;
                const key = imageData.key;

                const div = document.createElement('div');
                div.classList.add('relative', 'group');

                const img = document.createElement('img');
                img.src = imageSrc;
                img.classList.add('w-full', 'h-auto', 'rounded-lg');

                // Botón de eliminar
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '✕';
                deleteBtn.setAttribute('aria-label', 'Eliminar imagen');
                deleteBtn.classList.add('absolute', 'top-2', 'right-2', 'bg-red-500', 'text-white', 'rounded-full', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'opacity-0', 'group-hover:opacity-100', 'transition');
                deleteBtn.onclick = () => {
                    deleteImage(key, imageData.name);
                };

                // Botón de sustituir
                const replaceBtn = document.createElement('button');
                replaceBtn.innerHTML = '⟳';
                replaceBtn.setAttribute('aria-label', 'Sustituir imagen');
                replaceBtn.classList.add('absolute', 'top-2', 'left-2', 'bg-yellow-500', 'text-white', 'rounded-full', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'opacity-0', 'group-hover:opacity-100', 'transition');
                replaceBtn.onclick = () => {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';
                    fileInput.onchange = () => {
                        const file = fileInput.files[0];
                        replaceImage(key, imageData.name, file);
                    };
                    fileInput.click();
                };

                div.appendChild(img);
                div.appendChild(deleteBtn);
                div.appendChild(replaceBtn);
                gallery.appendChild(div);
            });
        }

        // Eliminar imagen de Firebase
        function deleteImage(key, fileName) {
            // Eliminar de Firebase Storage
            const storageRef = storage.ref('images/' + fileName);
            storageRef.delete().then(() => {
                // Eliminar de Firebase Database
                database.ref('images/' + key).remove().then(() => {
                    loadImages();
                });
            }).catch((error) => {
                console.error('Error al eliminar la imagen:', error);
                alert('No se pudo eliminar la imagen.');
            });
        }

        // Reemplazar imagen en Firebase
        function replaceImage(key, oldFileName, newFile) {
            deleteImage(key, oldFileName);
            uploadFile(newFile);
        }
    </script>
</body>
</html>
